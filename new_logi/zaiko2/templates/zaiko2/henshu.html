{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'main.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="icon" href="{% static 'sanma.gif' %}">

    <title>店舗用サンプル在庫表（登録 / 編集）</title>

</head>
<body>
    <div class="mt-3 mb-5">

        <div style="margin: 0 auto; width: 1100px;">

            <!-- メニュー -->
            <div class="flex2">
                <div><a href="{% url 'zaiko:index' %}">出荷依頼</a></div>
                <div style="margin-left: 50px;"><a href="{% url 'zaiko2:henshu_index' %}">商品登録/編集</a></div>
                <div style="margin-left: 50px;"><a href="{% url 'zaiko2:size_index' %}">サイズ登録</a></div>
            </div>
            <hr>

        

            <!-- 商品検索 -->
            <div class="flex2">
                <div><i class="bi bi-search"></i> 商品検索：</div>
                <div style="width: 500px;"><input class="form-control" type="text" id="hinban_enter"></div>
            </div>
            <div class="mt-3">
                <select class="form-control" id="hinban" style="width: 600px; height:120px;" size="5"></select>
            </div>
                
            <!-- 商品一覧 -->
            <div class="inlineframe mt-3" style="height: 350px; width: 100%;">
                <table class="table table-bordered tb_zaiko sticky_table" style="font-size: 0.9em;">
                    <thead>
                        <tr class="table-secondary">
                            <th>カラー</th>
                            <th>サイズ</th>
                            <th style="width: 80px;">キープ数</th>
                            <th style="width: 80px;">在庫数</th>
                            <th>棚番</th>
                            <th>拠点</th>
                            <th>備考</th>
                            <th>注意事項</th>
                        </tr>
                    </thead>
                    <tbody id="item_list"></tbody> 
                </table>
            </div>
            
            

        </div>
        

    </div>



    <!-- 各種Ajax -->
    <script>

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i <cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
  
        var csrftoken = getCookie('csrftoken');
  
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
  
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
  

        
        //品番検索
        var hinban_enter = document.getElementById("hinban_enter");
        hinban_enter.addEventListener("input",function(){
            if (hinban_enter.value == ""){
                document.getElementById("hinban").innerHTML="";
                document.getElementById("item").innerHTML="";
                clear();
                return
            };
            $.ajax({
                'url': '{% url "zaiko2:henshu_hinban_enter" %}',
                'type': 'POST',
                'data': {
                    'hinban_enter': hinban_enter.value,
                    'team': document.getElementById("team_select").value
                },
                'dataType': 'json'
            })
            .done(function(response){
                var list = "";
                if (response.hinban_list.length == 0){
                    list='<option></option>';
                } else {
                    for (var i of response.hinban_list){
                        list = list + "<option value='" + i + "'>" + i + "</option>";
                    }
                }
                document.getElementById("hinban").innerHTML=list;
            });
        });


        //品番選択
        var hinban = document.getElementById("hinban");
        hinban.addEventListener("click",function(){
            var team = document.getElementById("team_select");
            if (hinban.value != "" && team.value != ""){
                $.ajax({
                    'url': '{% url "zaiko2:henshu_hinban_click" %}',
                    'type': 'POST',
                    'data': {
                        'team': team.value,
                        'hinban': hinban.value,
                        },
                    'dataType': 'json'
                })
                .done(function(response){
                    res=response.item_list;
                    var str="";
                    var rental="";
                    for (var i of res){
                        if (i.joutai == 0){
                            rental="あり";
                        } else if(i.joutai ==1){
                            rental="貸出中";
                        } else{
                            rental="廃番";
                        };
                        str=str + "<div class='flex2 main_henshu' id='" + i.hontai_num + "' name='henshu_item'>" + 
                            "<div style='width:100px;'>" + i.shouhin_num + "</div>" + 
                            "<div style='width:300px;padding-right:15px'>" + i.shouhin_name + "</div>" + 
                            "<div style='width:170px;'>" + i.color + "</div>" + 
                            "<div style='width:100px;'>" + i.size + "</div>" + 
                            "<div style='width:230px;'>" + i.tana + "</div>" + 
                            "<div style='width:80px;'>" + rental + "</div>" + 
                            "</div>";
                    };
                    document.getElementById("item").innerHTML=str;
                    list_click();
                });
            };
        });


        // 店舗選択
        document.getElementById("team_select").addEventListener("change",function(){
            document.getElementById("hinban_enter").value="";
            document.getElementById("hinban").innerHTML="<option></option>";
            document.getElementById("item").innerHTML="";
        });

        
        // リストクリック
        function list_click(){
            var item=document.getElementsByName("henshu_item");
            for (i=0; i<item.length; i++){
                item[i].addEventListener("click",function(){
                    $.ajax({
                        'url': '{% url "zaiko2:henshu_list_click" %}',
                        'type': 'POST',
                        'data': {'hontai_num': this.id},
                        'dataType': 'json'
                    })
                    .done(function(response){
                        res=response.item;
                        document.getElementById("up_hontai_num").innerText=res.hontai_num;
                        document.getElementById("up_team").value=res.team;
                        document.getElementById("up_shouhin_num").value=res.shouhin_num;
                        document.getElementById("up_color").value=res.color;
                        document.getElementById("up_size").value=res.size;
                        document.getElementById("up_tana").value=res.tana;
                        document.getElementById("up_shouhin_name").value=res.shouhin_name;
                        document.getElementById("up_joutai").value=res.joutai;
                        document.getElementById("up_rental_day").value=res.rental_day;
                        document.getElementById("up_rental_tantou").value=res.rental_tantou;
                        document.getElementById("up_rental_cus").value=res.rental_cus;
                        document.getElementById("up_bikou").value=res.bikou;
                        document.getElementById("up_btn").className="btn btn-success";
                        document.getElementById("up_btn").innerHTML="<i class='bi bi-upload'></i> 内容更新";
                        tana();
                    });
                });
            };
        };

        
        // 内容コピー
        document.getElementById("detail_copy").addEventListener("click",function(){
            var hontai_num=document.getElementById("up_hontai_num");
            if(hontai_num.innerText == ""){
                window.alert("コピーする対象をリストから選択してください！");
                return
            };
            hontai_num.innerText="";
            document.getElementById("up_joutai").value="0";
            document.getElementById("up_rental_day").value="";
            document.getElementById("up_rental_tantou").value="";
            document.getElementById("up_rental_cus").value="";
            document.getElementById("up_btn").className="btn btn-primary";
            document.getElementById("up_btn").innerHTML="<i class='bi bi-plus-lg'></i> 新規登録";  
            window.alert("内容をコピーしました！");
        });
        

        // クリアボタン
        document.getElementById("detail_clear").addEventListener("click",function(){
            clear();
        });


        // クリア動作
        function clear(){
            document.getElementById("up_hontai_num").innerText="";
            var team=document.getElementById("ses_team").innerText;
            if (team=="全店舗"){
                document.getElementById("up_team").value="";
            } else {
                document.getElementById("up_team").value=team;
            };
            document.getElementById("up_shouhin_num").value="";
            document.getElementById("up_color").value="";
            document.getElementById("up_size").value="";
            document.getElementById("up_tana").value="";
            document.getElementById("up_shouhin_name").value="";
            document.getElementById("up_joutai").value="0";
            document.getElementById("up_rental_day").value="";
            document.getElementById("up_rental_tantou").value="";
            document.getElementById("up_rental_cus").value="";
            document.getElementById("up_bikou").value="";
            document.getElementById("up_btn").className="btn btn-primary";
            document.getElementById("up_btn").innerHTML="<i class='bi bi-plus-lg'></i> 新規登録";
            tana();
        };


        // 登録・更新
        document.getElementById("up_btn").addEventListener("click",function(){
            var str="";
            if(document.getElementById("up_team").value == ""){str=str + "店舗を指定してください！\n"};
            if(document.getElementById("up_shouhin_num").value == ""){str=str + "商品番号を入力してください！\n";};            
            if(document.getElementById("up_shouhin_name").value == ""){str=str + "商品名を入力してください！\n";};      
            if(document.getElementById("up_size").value == ""){str=str + "サイズを選択してください！";};
            if(str != ""){
                window.alert(str);
                return
            };
            $.ajax({
                'url': '{% url "zaiko2:henshu_up" %}',
                'type': 'POST',
                'data': {
                    'hontai_num': document.getElementById("up_hontai_num").innerText,
                    'team': document.getElementById("up_team").value,
                    'shouhin_num': document.getElementById("up_shouhin_num").value,
                    'shouhin_name': document.getElementById("up_shouhin_name").value,
                    'color': document.getElementById("up_color").value,
                    'size': document.getElementById("up_size").value,
                    'tana': document.getElementById("up_tana").value,
                    'joutai': document.getElementById("up_joutai").value,
                    'rental_day': document.getElementById("up_rental_day").value,
                    'rental_tantou': document.getElementById("up_rental_tantou").value,
                    'rental_cus': document.getElementById("up_rental_cus").value,
                    'bikou': document.getElementById("up_bikou").value,
                },
                'dataType': 'json'
            })
            .done(function(response){
                if (document.getElementById("up_hontai_num").innerText == ""){
                    window.alert("新規登録が完了しました！");
                } else {
                    window.alert("登録内容を更新しました！");
                };
                window.location.reload();
            });
        });



        // 登録削除
        var hontai_num = document.getElementById("up_hontai_num");
        document.getElementById("btn_del").addEventListener("click",function(){
            if (hontai_num.innerText == ""){
                window.alert("削除する対象をリストから選択してください！");
                return
            };
            var ans =confirm("本当に削除しますか？");
            if (ans == false){
                return
            };
            $.ajax({
                'url': '{% url "zaiko2:henshu_del" %}',
                'type': 'POST',
                'data': {'hontai_num': hontai_num.innerText},
                'dataType': 'json'
            })
            .done(function(response){
                window.location.reload();
                window.alert("削除しました！");                
            });
        });

    </script>


</body>
</html>